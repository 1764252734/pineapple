# 地面站功能  
  
本文档是关于地面站功能（航点、热点环绕、跟随）中数据类型及推送数据的具体介绍，更多关于地面站控制指令请参考[开放协议](开放协议.md)中地面站功能部分。

## 航点功能

### 数据类型: waypoint_mission_info_comm_t

<table>
    <tr>
        <th>数据类型</th>
        <th>数据名称</th>
        <th>描述</th>
    </tr>
    <tr>
        <td>uint8_t</td>
        <td>length</td>
        <td>航点数量</td>
    </tr>
    <tr>
        <td>float32</td>
        <td>vel_cmd_range</td>
        <td>摇杆输入时最大速度(2~15 m)</td>
    </tr>
    <tr>
        <td>float32</td>
        <td>idle_vel</td>
        <td>巡航速度(无摇杆输入时速度，大小不可大于vel_cmd_range)</td>
    </tr>
    <tr>
        <td>uint8_t</td>
        <td>action_on_finish</td>
        <td>完成后动作<ul>
            <li>0: 无动作</li>
            <li>1: 自动返航</li>
            <li>2: 自动降落</li>
            <li>3: 返回0号航点</li>
            <li>4: 无限模式，不退出</li>
        </ul></td>
    </tr>
    <tr>
        <td>uint8_t</td>
        <td>mission_exec_num</td>
        <td>功能执行次数<ul>
            <li>1: 执行1次</li>
            <li>2: 执行2次</li>
        </ul></td>
    </tr>
    <tr>
        <td>uint8_t</td>
        <td>yaw_mode</td>
        <td>航向模式<ul>
            <li>0: 自动模式(自动指向下一航点)</li>
            <li>1: 锁定为初始值</li>
            <li>2: 使用遥控器控制</li>
            <li>3: 使用航点设定的航向(tgt_yaw)</li>
        </ul></td>
    </tr>
    <tr>
        <td>uint8_t</td>
        <td>trace_mode</td>
        <td>轨迹模式<ul>
            <li>0: 点到点飞行,到达目标航点后悬停，完成航点动作(若有)后，飞往下一个航点</li>
            <li>1: 协调转弯模式，航点间平滑过度，不执行航点任务</li>
        </ul></td>
    </tr>
    <tr>
        <td>uint8_t</td>
        <td>action_on_rc_lost</td>
        <td>遥控信号丢失动作<ul>
            <li>0: 退出航点功能，执行失控功能</li>
            <li>1: 继续执行航点飞行</li>
        </ul></td>
    </tr>
    <tr>
        <td>uint8_t</td>
        <td>gimbal_pitch_mode</td>
        <td>云台pitch模式<ul>
            <li>0: 自由模式，不控制云台</li>
            <li>1: 自动模式，航点间平滑过度</li>
        </ul></td>
    </tr>
    <tr>
        <td>double</td>
        <td>hp_lati</td>
        <td>兴趣点纬度（弧度）</td>
    </tr>
    <tr>
        <td>double</td>
        <td>hp_longti</td>
        <td>兴趣点经度（弧度）</td>
    </tr>
    <tr>
        <td>double</td>
        <td>hp_alti</td>
        <td>兴趣点高度（相对起飞点高度）</td>
    </tr>
    <tr>
        <td>uint8_t</td>
        <td>resv[16]</td>
        <td>保留</td>
    </tr>
</table>


### 数据类型: waypoint_comm_t

<table>
    <tr>
        <th>数据类型</th>
        <th>数据名称</th>
        <th>描述</th>
    </tr>
    <tr>
        <td>double</td>
        <td>lati</td>
        <td>航点纬度（弧度）</td>
    </tr>
    <tr>
        <td>double</td>
        <td>longti</td>
        <td>航点经度（弧度）</td>
    </tr>
    <tr>
        <td>float</td>
        <td>alti</td>
        <td>航点高度（相对起飞点高度）</td>
    </tr>
    <tr>
        <td>float</td>
        <td>damping_dis</td>
        <td>转弯处长度（仅协调转弯模式下有效）</td>
    </tr>
    <tr>
        <td>int16_t</td>
        <td>tgt_yaw</td>
        <td>航点航向（角度）</td>
    </tr>
    <tr>
        <td>int16_t</td>
        <td>tgt_gimbal_pitch</td>
        <td>航点云台pitch</td>
    </tr>
    <tr>
        <td>uint8_t</td>
        <td>turn_mode</td>
        <td>转向方式<ul>
            <li>0: 顺时针</li>
            <li>1: 逆时针</li>
        </ul></td>
    </tr>
    <tr>
        <td>uint8_t</td>
        <td>resv[8]</td>
        <td>保留</td>
    </tr>
    <tr>
        <td>uint8_t</td>
        <td>has_action</td>
        <td>是否包含航点动作<ul>
            <li>0: 该航点无动作</li>
            <li>1: 该航点有动作</li>
        </ul></td>
    </tr>
    <tr>
        <td>uint16_t</td>
        <td>action_time_limit</td>
        <td>航点动作限制时间 单位:s</td>
    </tr>
    <tr>
        <td>waypoint_action_comm_t</td>
        <td>action</td>
        <td>航点动作</td>
    </tr>
</table>

### 数据类型: waypoint_action_comm_t
<table>
    <tr>
        <th>数据类型</th>
        <th>数据名称</th>
        <th>描述</th>
    </tr>
    <tr>
        <td>uint8_t :4</td>
        <td>action_num</td>
        <td>动作数量</td>
    </tr>
    <tr>
        <td>uint8_t :4</td>
        <td>action_rpt</td>
        <td>重复次数</td>
    </tr>
    <tr>
        <td>uint8_t</td>
        <td>command_list[WP_ACTION_MAX_NUM]</td>
        <td>命令列表</td>
    </tr>
    <tr>
        <td>int16_t</td>
        <td>command_param[WP_ACTION_MAX_NUM]</td>
        <td>命令参数</td>
    </tr>
</table>

### 命令介绍


|命令|命令值|命令参数|描述|
|----|------|--------|----|
|WP_ACTION_STAY|0|悬停时间 单位：毫秒|仅悬停一定时间|
|WP_ACTION_SIMPLE_SHOT|1|N/A|拍照|
|WP_ACTION_VIDEO_START|2|N/A|开始摄像|
|WP_ACTION_VIDEO_STOP|3|N/A|停止摄像|
|WP_ACTION_CRAFT_YAW|4|航向角度值(-180~180)|调整飞行器朝向|
|WP_ACTION_GIMBAL_PITCH|5|PITCH角度值(-90~0)|调整云台俯仰0为平视，-90为俯视|



## 热点功能
### 数据类型: hotpoint_mission_setting_t

<table>
    <tr>
        <th>数据类型</th>
        <th>数据名称</th>
        <th>描述</th>
    </tr>
    <tr>
        <td>uint8_t</td>
        <td>version</td>
        <td>保留</td>
    </tr>
    <tr>
        <td>double</td>
        <td>hp_lati</td>
        <td>热点纬度（弧度）</td>
    </tr>
    <tr>
        <td>double</td>
        <td>hp_lonti</td>
        <td>热点经度（弧度）</td>
    </tr>
    <tr>
        <td>double</td>
        <td>hp_alti</td>
        <td>热点高度（相对起飞点高度）</td>
    </tr>
    <tr>
        <td>double</td>
        <td>hp_radius</td>
        <td>热点半径(5m~500m)</td>
    </tr>
    <tr>
        <td>float</td>
        <td>angle_rate</td>
        <td>环绕速度(0~30°/s)</td>
    </tr>
    <tr>
        <td>uint8_t</td>
        <td>is_clockwise</td>
        <td>旋转方向<ul>
            <li>0: 逆时针</li>
            <li>1: 顺时针</li>
        </ul></td>
    </tr>
    <tr>
        <td>uint8_t</td>
        <td>start_point</td>
        <td>起始点<ul>
            <li>0: 兴趣点环绕圆环的最北点</li>
            <li>1: 兴趣点环绕圆环的最南点</li>
            <li>2: 兴趣点环绕圆环的最西点</li>
            <li>3: 兴趣点环绕圆环的最东点</li>
            <li>4: 距离兴趣点环绕圆环最近的点</li>
        </ul></td>
    </tr>
    <tr>
        <td>uint8_t</td>
        <td>yaw_mode</td>
        <td>航向模式<ul>
            <li>0: 指向速度方向</li>
            <li>1: 指向兴趣点</li>
            <li>2: 背向兴趣点</li>
            <li>3: 使用遥控器控制</li>
            <li>5: 背向速度方向</li>
        </ul></td>
    </tr>
    <tr>
        <td>uint8_t</td>
        <td>reserved[11]</td>
        <td>保留</td>
    </tr>
</table>
## 跟随功能

### 数据类型: follow_me_mission_setting_t

<table>
    <tr>
        <th>数据类型</th>
        <th>数据名称</th>
        <th>描述</th>
    </tr>
    <tr>
        <td>uint8_t</td>
        <td>follow_mode</td>
        <td>跟随方式(保留)</td>
    </tr>
    <tr>
        <td>uint8_t</td>
        <td>yaw_mode</td>
        <td>航向模式<ul>
            <li>1: 指向追踪点</li>
            <li>0: 使用遥控器控制</li>
        </ul></td>
    </tr>
    <tr>
        <td>double</td>
        <td>init_latitude</td>
        <td>初始纬度（弧度）</td>
    </tr>
    <tr>
        <td>double</td>
        <td>init_longitude</td>
        <td>初始经度（弧度）</td>
    </tr>
    <tr>
        <td>uint16_t</td>
        <td>init_alti</td>
        <td>保留</td>
    </tr>
    <tr>
        <td>uint16_t</td>
        <td>init_mag_angle</td>
        <td>保留</td>
    </tr>
    <tr>
        <td>uint8_t</td>
        <td>follow_sensitivity</td>
        <td>保留</td>
    </tr>
</table>

### 数据类型: cmd_mission_follow_target_info

<table>
    <tr>
        <th>数据类型</th>
        <th>数据名称</th>
        <th>描述</th>
    </tr>
    <tr>
        <td>double</td>
        <td>lati</td>
        <td>目标纬度（弧度）</td>
    </tr>
    <tr>
        <td>double</td>
        <td>lonti</td>
        <td>目标经度（弧度）</td>
    </tr>
    <tr>
        <td>uint16_t</td>
        <td>alti</td>
        <td>保留</td>
    </tr>
    <tr>
        <td>uint16_t</td>
        <td>mag_angle</td>
        <td>保留</td>
    </tr>
</table>
---
## 命令集0x02 命令码0x03 地面站状态包
状态包第一个字节'mission_type'说明状态包类型。状态包类型定义如下:
~~~c
typedef enum
{
    NAVI_MODE_ATTI,
    NAVI_MISSION_WAYPOINT,
    NAVI_MISSION_HOTPOINT,
    NAVI_MISSION_FOLLOWME,
    NAVI_MISSION_IOC,
}navi_type;
~~~
###航点状态(NAVI_MISSION_WAYPOINT)

<table>
    <tr>
        <th>数据类型</th>
        <th>数据名称</th>
        <th>描述</th>
    </tr>
    <tr>
        <td>uint8_t</td>
        <td>mission_type</td>
        <td>任务类型</td>
    </tr>
    <tr>
        <td>uint8_t</td>
        <td>target_waypoint</td>
        <td>当前航点</td>
    </tr>
    <tr>
        <td>uint8_t</td>
        <td>curr_state</td>
        <td>当前位置</td>
    </tr>
    <tr>
        <td>uint8_t</td>
        <td>error_notification</td>
        <td>错误信息</td>
    </tr>
    <tr>
        <td>uint16_t</td>
        <td>running_status</td>
        <td>任务状态<ul>
            <li>0: 未运行</li>
            <li>1: 运行中</li>
            <li>2: 暂停</li>
        </ul></td>
    </tr>
</table>
###热点状态(NAVI_MISSION_HOTPOINT)

<table>
    <tr>
        <th>数据类型</th>
        <th>数据名称</th>
        <th>描述</th>
    </tr>
    <tr>
        <td>uint8_t</td>
        <td>mission_type</td>
        <td>任务类型</td>
    </tr>
    <tr>
        <td>uint8_t</td>
        <td>mission_status</td>
        <td>任务状态<ul>
            <li>0:初始化</li>
            <li>1:运行中</li>
            <li>2:暂停</li>
        </ul></td>
    </tr>
    <tr>
        <td>uint16_t</td>
        <td>hp_exec_radius</td>
        <td>距热点距离单位：cm</td>
    </tr>
    <tr>
        <td>uint8_t</td>
        <td>reason</td>
        <td>状态</td>
    </tr>
    <tr>
        <td>uint8_t</td>
        <td>hp_exec_vel</td>
        <td>环绕线速度*10并取整</td>
    </tr>
</table>
###跟随状态(NAVI_MISSION_FOLLOWME)

<table>
    <tr>
        <th>数据类型</th>
        <th>数据名称</th>
        <th>描述</th>
    </tr>
    <tr>
        <td>uint8_t</td>
        <td>mission_type</td>
        <td>任务类型</td>
    </tr>
    <tr>
        <td>uint8_t:4</td>
        <td>mission_status</td>
        <td>任务状态机<ul>
            <li>0: 初始化</li>
            <li>1: 跟随中</li>
            <li>2: 等待中（飞机自身GPS等级小于或等于4；跟随目标信息断开超过6s）</li>
        </ul></td>
    </tr>
        <tr>
        <td>uint8_t:4</td>
        <td>gps_level</td>
        <td>飞机GPS等级<ul>
            <li>0: GPS_SIGNAL_LEVEL_0</li>
            <li>1: GPS_SIGNAL_LEVEL_1</li>
            <li>2: GPS_SIGNAL_LEVEL_2</li>
            <li>3: GPS_SIGNAL_LEVEL_3</li>
            <li>4: GPS_SIGNAL_LEVEL_4</li>
            <li>5: GPS_SIGNAL_LEVEL_5</li>
        </ul></td>
    </tr>
    <tr>
        <td>uint16_t</td>
        <td>drone2target_dist</td>
        <td>目标到飞机的距离 单位cm</td>
    </tr>
    <tr>
        <td>uint8_t</td>
        <td>reason</td>
        <td>错误码</td>
    </tr>
    <tr>
        <td>uint8_t</td>
        <td>package_interval_time</td>
        <td>时间间隔频率 单位 0.02s</td>
    </tr>
</table>
###其他状态(NAVI_MODE_ATTI & NAVI_MISSION_IOC)

<table>
    <tr>
        <th>数据类型</th>
        <th>数据名称</th>
        <th>描述</th>
    </tr>
    <tr>
        <td>uint8_t</td>
        <td>mission_type</td>
        <td>任务类型</td>
    </tr>
    <tr>
        <td>uint8_t</td>
        <td>last_mission_type</td>
        <td>上一次地面站任务类型</td>
    </tr>
    <tr>
        <td>uint8_t :1</td>
        <td>is_broken</td>
        <td>mission_type = NAVI_MODE_ATTI: <ul>有任务因条件不满足而自动退出</ul>
            mission_type = NAVI_MODE_IOC: <ul>IOC因条件不满足而无法执行</ul></td>
    </tr>
    <tr>
        <td>uint8_t :7</td>
        <td>reserved1</td>
        <td>保留</td>
    </tr>
    <tr>
        <td>uint8_t</td>
        <td>reason</td>
        <td>当is_broken为ture时，表示任务无法执行的原因（错误码）</td>
    </tr>
    <tr>
        <td>uint8_t</td>
        <td>reserved2</td>
        <td>保留</td>
    </tr>
    <tr>
        <td>uint8_t</td>
        <td>reserved3</td>
        <td>保留</td>
    </tr>
</table>



## 命令集0x02 命令码0x04 航点事件
第一个字节'incident_type'说明事件类型。事件类型定义如下:
~~~c
typedef enum
{
    NAVI_UPLOAD_FINISH,
    NAVI_MISSION_FINISH,
    NAVI_MISSION_WP_REACH_POINT,
}incident_type;
~~~
### 数据上传(NAVI_UPLOAD_FINISH)
<table>
    <tr>
        <th>数据类型</th>
        <th>数据名称</th>
        <th>描述</th>
    </tr>
    <tr>
        <td>uint8_t</td>
        <td>incident_type</td>
        <td>事件类型</td>
    </tr>
    <tr>
        <td>uint8_t</td>
        <td>is_mission_vaild</td>
        <td>任务可用性</td>
    </tr>
    <tr>
        <td>uint16_t</td>
        <td>estimated_run_time</td>
        <td>执行所需时间</td>
    </tr>
    <tr>
        <td>uint16_t</td>
        <td>reserved</td>
        <td>保留</td>
    </tr>
</table>
### 任务完成(NAVI_MISSION_FINISH)
<table>
    <tr>
        <th>数据类型</th>
        <th>数据名称</th>
        <th>描述</th>
    </tr>
    <tr>
        <td>uint8_t</td>
        <td>incident_type</td>
        <td>事件类型</td>
    </tr>
    <tr>
        <td>uint8_t</td>
        <td>repeat</td>
        <td>航线完成后动作</td>
    </tr>
    <tr>
        <td>uint16_t</td>
        <td>reserved</td>
        <td>保留</td>
    </tr>
    <tr>
        <td>uint16_t</td>
        <td>reserved2</td>
        <td>保留</td>
    </tr>
</table>
### 到达目标点(NAVI_MISSION_WP_REACH_POINT)
<table>
    <tr>
        <th>数据类型</th>
        <th>数据名称</th>
        <th>描述</th>
    </tr>
    <tr>
        <td>uint8_t</td>
        <td>incident_type</td>
        <td>事件类型</td>
    </tr>
    <tr>
        <td>uint8_t</td>
        <td>waypoint_index</td>
        <td>航点索引</td>
    </tr>
    <tr>
        <td>uint8_t</td>
        <td>curr_state</td>
        <td>当前状态</td>
    </tr>
    <tr>
        <td>uint8_t</td>
        <td>reserved</td>
        <td>保留</td>
    </tr>
    <tr>
        <td>uint16_t</td>
        <td>reserved2</td>
        <td>保留</td>
    </tr>
</table>
